window.__INITIAL_STATE__ = {"widgetType":null,"apiUrl":"https://static2.zotabox.com","baseUrl":"https://static2.zotabox.com","mediaDomain":"https://file.zotabox.com","actionDomain":"https://actions.zotabox.com"}
Zotabox.baseUrl = 'https://static2.zotabox.com'
Zotabox.scripts = ["/assets/index-CA7tNJhF.js"]
Zotabox.stylesheet = []

function ZotaboxInit(html, isProduction) {
    // Check if location.hash is #zbrc, then send a request to clear cache
    if (window.location.hash === "#nzbrc" ||window.location.hash === "#zbrc") {
        const data = {
            domain_platform: Zotabox.platform,
            domain_id: Zotabox.domain_id,
            widget_type: Zotabox.widgets
        };

        fetch(Zotabox.baseUrl+"/cache/clear", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(result => {
            console.log("Cache cleared:", result);
            window.location.hash = "#ok";
            window.location.reload();
        })
        .catch(error => console.error("Error clearing cache:", error));
        return;
    }

    if (!window.Zotabox?.isLoaded) {
        window.Zotabox.isLoaded = true;
        const zotaboxWidget = document.createElement('div');
        zotaboxWidget.innerHTML = html;
        document.body.appendChild(zotaboxWidget);

        // Load scripts
        Zotabox.scripts?.forEach(tagSrc => {
            if (!document.querySelector(`script[src="${Zotabox.baseUrl + tagSrc}"]`)) {
                const scriptTag = document.createElement('script');
                scriptTag.src = Zotabox.baseUrl + tagSrc;
                scriptTag.type = isProduction ? "text/javascript" : "module";
                scriptTag.async = true;
                document.body.appendChild(scriptTag);
            }
        });

        // Load stylesheets
        Zotabox.stylesheet?.forEach(cssSrc => {
            if (!document.querySelector(`link[href="${Zotabox.baseUrl + cssSrc}"]`)) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = Zotabox.baseUrl + cssSrc;
                link.media = 'all';
                document.head.appendChild(link);
            }
        });
    }

    let retries = 0;
    const maxRetries = 50; // Giới hạn số lần chạy để tránh loop vô hạn
    const checkWidgetInit = setInterval(() => {
        if (typeof initWidgets !== 'undefined') {
            //for shopline
            if(typeof Zotabox.platform != 'undefined' && Zotabox.platform == 'shopline'){
                var shoplineMerchantId = null;
                if(typeof window.mainConfig != 'undefined'){
                    shoplineMerchantId = window.mainConfig.merchantId ?? null;
                }
                if(shoplineMerchantId != null){
                    Zotabox.domain_id = shoplineMerchantId;
                }
            }
            if (Zotabox?.widgets?.length > 0) {
                initWidgets(Zotabox.domain_id, Zotabox.widgets.shift(), Zotabox.platform);
                clearInterval(checkWidgetInit);
            } else {
                initWidgets(Zotabox.domain_id, null, Zotabox.platform);
                clearInterval(checkWidgetInit);
            }
        } else if (retries++ >= maxRetries) {
            clearInterval(checkWidgetInit);
        }
    }, 100);
}
ZotaboxInit("<div id=\"zotabox-app\"></div>", true)